<!doctype html>
<!--[if lt IE 7 ]><html itemscope itemtype="http://schema.org/Organization" id="ie6" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 7 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie7" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 8 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie8" class="ie ie-old" lang="en-US"><![endif]-->
<!--[if IE 9 ]>   <html itemscope itemtype="http://schema.org/Organization" id="ie9" class="ie" lang="en-US"><![endif]-->
<!--[if gt IE 9]><!--><html itemscope itemtype="http://schema.org/Organization" lang="en-US"><!--<![endif]-->
<head>

    <!-- Meta -->
    <meta charset="utf-8">
    <title>Retrieve Data From A Relational Source - MarkLogic NiFi Processors</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Favicons -->
    <link rel="shortcut icon" sizes="16x16 24x24 32x32 48x48 64x64 96x96" href="/nifi/favicon.ico">
    <meta name="application-name" content="MarkLogic NiFi Processors - NiFi Processors for interacting with MarkLogic">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-6638631-15', 'auto');
      ga('send', 'pageview');

    </script>

    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
    document,'script','https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1879746318909687'); // Insert your pixel ID here.
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1879746318909687&ev=PageView&noscript=1"
    /></noscript>
    <!-- DO NOT MODIFY -->
    <!-- End Facebook Pixel Code -->
    <link type="text/css" rel="stylesheet" href="/nifi/assets/bundle.css">
</head>
<body class="">

    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/nifi">
                  <span class="logo">
                    <img src="/nifi/images/logo-marklogic.svg" width="180px" height="38px" alt="MarkLogic" title="MarkLogic" scale="0">
                  </span>
                  MarkLogic NiFi Processors
                </a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    
                        <li  >
                            
                            <a href="/nifi/getting-started">Getting Started</a>
                            
                        </li>
                    
                        <li  >
                            
                            <a href="https://github.com/marklogic/nifi">GitHub</a>
                            
                        </li>
                    
                </ul>
            </div>
        </div>
    </nav>




  <article>
    <div class="container">
      <div class="row">
        <div class="side-nav col-md-3 hide-small">
          <div class="panel panel-default">
  <div class="panel-heading">Navigation</div>
  <ul class="list-group">
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/">Introduction</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/getting-started">Getting Started</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/step-by-step">Step-by-Step Guide</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/nifi-features">NiFi Features</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/cookbook-recipes">Cookbook Recipes</a>
    
    
      <ul class="list-group">
  
  <li  class="list-group-item active"  >
    
    <a href="/nifi/get-data-from-a-relational-database">Relational Database to MarkLogic</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/file-system-to-marklogic">File System to MarkLogic</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/run-data-hub-input-flow">Run Data Hub Input Flow</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/step-by-step#add-querymarklogic-processor">Extract MarkLogic Documents</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/bulk-record-insert-into-marklogic">Bulk Record Insert Into MarkLogic</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/dhf-with-smart-mastering">DHF With Smart Mastering</a>
    
    
  </li>
  
</ul>

    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/error-resolutions">Error Resolutions</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/performance-considerations">Performance Considerations</a>
    
    
  </li>
  
  <li  class="list-group-item"  >
    
    <a href="/nifi/faqs">FAQs</a>
    
    
  </li>
  
</ul>

</div>

        </div>
        <div class="col-md-9">
          <h1 id="retrieve-data-from-a-relational-source">Retrieve Data From A Relational Source</h1>

<p>There are several available processors for working with relational data.</p>

<h2 id="available-relational-processors">Available Relational Processors</h2>

<p>Descriptions for these processors were taken directly from the processor documentation. For our cookbook we will be using <code class="highlighter-rouge">GenerateTableFetch</code> and <code class="highlighter-rouge">ExecuteSQL</code> together in order to page over the result set.</p>

<h3 id="executesql">ExecuteSQL</h3>

<p>Executes provided SQL select query. Query result will be converted to Avro format. Streaming is used so arbitrarily large result sets are supported. This processor can be scheduled to run on a timer, or cron expression, using the standard scheduling methods, or it can be triggered by an incoming FlowFile. If it is triggered by an incoming FlowFile, then attributes of that FlowFile will be available when evaluating the select query, and the query may use the ? to escape parameters. In this case, the parameters to use must exist as FlowFile attributes with the naming convention sql.args.N.type and sql.args.N.value, where N is a positive integer. The sql.args.N.type is expected to be a number indicating the JDBC Type. The content of the FlowFile is expected to be in UTF-8 format. FlowFile attribute ‘executesql.row.count’ indicates how many rows were selected.</p>

<h3 id="generatetablefetch">GenerateTableFetch</h3>

<p>Generates SQL select queries that fetch “pages” of rows from a table. The partition size property, along with the table’s row count, determine the size and number of pages and generated FlowFiles. In addition, incremental fetching can be achieved by setting Maximum-Value Columns, which causes the processor to track the columns’ maximum values, thus only fetching rows whose columns’ values exceed the observed maximums. This processor is intended to be run on the Primary Node only.</p>

<p>This processor can accept incoming connections; the behavior of the processor is different whether incoming connections are provided:</p>
<ul>
  <li>If no incoming connection(s) are specified, the processor will generate SQL queries on the specified processor schedule. Expression Language is supported for many fields, but no flow file attributes are available. However the properties will be evaluated using the Variable Registry.</li>
  <li>If incoming connection(s) are specified and no flow file is available to a processor task, no work will be performed.</li>
  <li>If incoming connection(s) are specified and a flow file is available to a processor task, the flow file’s attributes may be used in Expression Language for such fields as Table Name and others. However, the Max-Value Columns and Columns to Return fields must be empty or refer to columns that are available in each specified table.</li>
</ul>

<h3 id="querydatabasetable">QueryDatabaseTable</h3>

<p>Generates a SQL select query, or uses a provided statement, and executes it to fetch all rows whose values in the specified Maximum Value column(s) are larger than the previously-seen maxima. Query result will be converted to Avro format. Expression Language is supported for several properties, but no incoming connections are permitted. The Variable Registry may be used to provide values for any property containing Expression Language. If it is desired to leverage flow file attributes to perform these queries, the GenerateTableFetch and/or ExecuteSQL processors can be used for this purpose. Streaming is used so arbitrarily large result sets are supported. This processor can be scheduled to run on a timer or cron expression, using the standard scheduling methods. This processor is intended to be run on the Primary Node only. FlowFile attribute ‘querydbtable.row.count’ indicates how many rows were selected.</p>

<h2 id="nifi-template-example">NiFi Template Example</h2>

<p>You can download a copy of the NiFi template used for this example <a href="./files/RelationalDatabaseToMarkLogic.xml" download="">here</a>.</p>

<h3 id="setup">Setup</h3>

<p>To use NiFi with relational you need a relational database and a JDBC driver. This cookbook will be using a dataset stored in MySql. In addition to requiring NiFi and MarkLogic setup (for instructions see <a href="./getting-started">Getting Started</a>), you will need the following software to follow along:</p>

<ul>
  <li><a href="https://dev.mysql.com/downloads/mysql/">MySql Server</a></li>
  <li><a href="https://dev.mysql.com/downloads/connector/j/">MySql Connector/J</a></li>
</ul>

<h3 id="dataset">Dataset</h3>

<p>Our relational cookbook uses the sample employee database located here:
<a href="https://github.com/datacharmer/test_db">https://github.com/datacharmer/test_db</a></p>

<p>Follow the instructions at the linked dataset repository to load your data.</p>

<p>There are about 300,000 employees in the database, so we will assume that that is too big for ExecuteSQL without paging.</p>

<p>Run the following SQL query, which will create the <code class="highlighter-rouge">employee_detail</code> view we will use for extracting data.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">USE</span> <span class="n">employees</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">VIEW</span> <span class="nv">`employee_detail`</span> <span class="k">SELECT</span> 
<span class="n">employees</span><span class="p">.</span><span class="n">emp_no</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">birth_date</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span>
<span class="n">employees</span><span class="p">.</span><span class="n">gender</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">hire_date</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">dept_emp</span><span class="p">.</span><span class="n">dept_no</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">departments</span><span class="p">.</span><span class="n">dept_name</span><span class="p">,</span>
<span class="n">employees</span><span class="p">.</span><span class="n">salaries</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">titles</span><span class="p">.</span><span class="n">title</span>
<span class="k">FROM</span> 
<span class="n">employees</span><span class="p">.</span><span class="n">employees</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">dept_emp</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">departments</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">salaries</span><span class="p">,</span> <span class="n">employees</span><span class="p">.</span><span class="n">titles</span>
<span class="k">WHERE</span> 
<span class="n">employees</span><span class="p">.</span><span class="n">employees</span><span class="p">.</span><span class="n">emp_no</span> <span class="o">=</span> <span class="n">employees</span><span class="p">.</span><span class="n">dept_emp</span><span class="p">.</span><span class="n">emp_no</span> <span class="k">AND</span>
<span class="n">employees</span><span class="p">.</span><span class="n">dept_emp</span><span class="p">.</span><span class="n">to_date</span> <span class="o">&gt;</span> <span class="n">CURDATE</span><span class="p">()</span> <span class="k">AND</span>
<span class="n">employees</span><span class="p">.</span><span class="n">dept_emp</span><span class="p">.</span><span class="n">dept_no</span> <span class="o">=</span> <span class="n">employees</span><span class="p">.</span><span class="n">departments</span><span class="p">.</span><span class="n">dept_no</span> <span class="k">AND</span>
<span class="n">employees</span><span class="p">.</span><span class="n">employees</span><span class="p">.</span><span class="n">emp_no</span> <span class="o">=</span> <span class="n">employees</span><span class="p">.</span><span class="n">salaries</span><span class="p">.</span><span class="n">emp_no</span> <span class="k">AND</span>
<span class="n">employees</span><span class="p">.</span><span class="n">salaries</span><span class="p">.</span><span class="n">to_date</span> <span class="o">&gt;</span> <span class="n">CURDATE</span><span class="p">()</span> <span class="k">AND</span>
<span class="n">employees</span><span class="p">.</span><span class="n">employees</span><span class="p">.</span><span class="n">emp_no</span> <span class="o">=</span> <span class="n">employees</span><span class="p">.</span><span class="n">titles</span><span class="p">.</span><span class="n">emp_no</span> <span class="k">AND</span>
<span class="n">employees</span><span class="p">.</span><span class="n">titles</span><span class="p">.</span><span class="n">to_date</span> <span class="o">&gt;</span> <span class="n">CURDATE</span><span class="p">()</span>
</code></pre></div></div>

<p>And here’s what the results form the <code class="highlighter-rouge">employee_detail</code> view will look like:
<img src="./images/02-007-employee-details-results.png" alt="Database results" /></p>

<h2 id="template-processor-setup">Template Processor Setup</h2>

<h3 id="generatetablefetch-settings">GenerateTableFetch Settings</h3>

<p><strong>Properties</strong></p>

<dl>
  <dt>Database Connection Pooling Service</dt>
  <dd>DBCPConnectionPool</dd>
  <dt>Database Type</dt>
  <dd>Generic</dd>
  <dt>Table Name</dt>
  <dd>employee_detail</dd>
  <dt>Columns to Return</dt>
  <dd>*</dd>
</dl>

<p><strong>Settings</strong></p>

<p>Automatically Terminate Relationships: failure</p>

<p>Scheduling</p>

<dl>
  <dt>Run Schedule</dt>
  <dd>1 day (prevents infinitely looping)</dd>
</dl>

<h3 id="executesql-settings">ExecuteSQL Settings</h3>

<p><strong>Properties</strong></p>

<dl>
  <dt>Database Connection Pooling Service</dt>
  <dd>DBCPConnectionPool</dd>
  <dt>SQL select query</dt>
  <dd><em>(leave this blank)</em></dd>
</dl>

<h3 id="splitavro-settings">SplitAvro Settings</h3>

<p><strong>Properties</strong></p>

<p><em>(all default)</em></p>

<p><strong>Settings</strong></p>

<dl>
  <dt>Automatically Terminate Relationships</dt>
  <dd>failure, original</dd>
</dl>

<h3 id="convertavrotojson-settings">ConvertAvroToJson Settings</h3>

<p><strong>Properties</strong></p>

<p><em>(all default)</em></p>

<p><strong>Settings</strong></p>

<dl>
  <dt>Automatically Terminate Relationships</dt>
  <dd>failure</dd>
</dl>

<h3 id="evaluatejsonpath-settings">EvaluateJsonPath Settings</h3>

<p>Store values from JSON in FlowFile properties</p>

<p><strong>Properties</strong></p>

<dl>
  <dt>Destination</dt>
  <dd>flowfile-attribute</dd>
  <dt>emp.no</dt>
  <dd>$.emp_no (custom property)</dd>
</dl>

<p><strong>Settings</strong></p>

<dl>
  <dt>Automatically Terminate Relationships</dt>
  <dd>failure, unmatched</dd>
</dl>

<h3 id="updateattribute-settings">UpdateAttribute Settings</h3>

<p><strong>Properties</strong></p>

<dl>
  <dt>marklogic.uri</dt>
  <dd>/employees/${emp.no}.json</dd>
</dl>

<h3 id="putmarklogic-settings">PutMarkLogic Settings</h3>

<p><strong>Properties</strong></p>

<dl>
  <dt>DatabaseClient Service</dt>
  <dd>DefaultMarkLogicDatabaseClientService</dd>
  <dt>Collections</dt>
  <dd>employees</dd>
  <dt>URI Attribute Name</dt>
  <dd>marklogic.uri</dd>
</dl>

<p>Settings</p>

<p>Check all check boxes under “Automatically Terminate Relationships”</p>

<h3 id="run-processors">Run Processors</h3>

<p>Select each of the processors and start them.</p>


        </div>
      </div>
    </div>
  </article>


    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>
                    Copyright © 2016-2019 MarkLogic Corporation. All Rights Reserved. MARKLOGIC® is a registered trademark of MarkLogic Corporation.
                    </p>
                </div>
            </div>
        </div>
    </footer>


    <!--[if lt IE 9]>
        <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="/nifi/js/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript" src="/nifi/assets/bundle.js" id="1"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-79716597-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>

